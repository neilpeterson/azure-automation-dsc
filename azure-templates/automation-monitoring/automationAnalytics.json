{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {},
	"variables": {
		"insights-sku": "standard",
		"linuxConfigurationName": "linux-package",
		"configurationName": "windows-features",
		"configurationDescription": "A configuration for installing IIS.",
		"configurationURI": "https://raw.githubusercontent.com/neilpeterson/azure-automation-dsc/master/support-scripts/windows-config.ps1",
		"linuxConfigurationURI": "https://raw.githubusercontent.com/neilpeterson/azure-automation-dsc/master/support-scripts/windows/windows-config.ps1",
		"nodeConfigurationName": "features.localhost",
		"automationAccountName": "[uniqueString(resourceGroup().id)]"
	},
	"resources": [
		{
			"name": "[variables('automationAccountName')]",
			"type": "Microsoft.Automation/automationAccounts",
			"apiVersion": "2015-10-31",
			"location": "[resourceGroup().location]",
			"comments": "Automation account for OMS",
			"properties": {
				"sku": {
					"name": "Basic"
				}
			},
			"resources": [
				{
					"name": "[variables('linuxConfigurationName')]",
					"type": "configurations",
					"apiVersion": "2015-10-31",
					"location": "[resourceGroup().location]",
					"tags": {},
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]"
					],
					"properties": {
						"logVerbose": true,
						"description": "[variables('configurationDescription')]",
						"state": "Published",
						"overwrite": "true",
						"source": {
							"type": "uri",
							"value": "[variables('linuxConfigurationURI')]"
						}
					}
				},
				{
					"name": "[variables('configurationName')]",
					"type": "configurations",
					"apiVersion": "2015-10-31",
					"location": "[resourceGroup().location]",
					"tags": {},
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]"
					],
					"properties": {
						"logVerbose": true,
						"description": "[variables('configurationDescription')]",
						"state": "Published",
						"overwrite": "true",
						"source": {
							"type": "uri",
							"value": "[variables('configurationURI')]"
						}
					}
				},
				{
					"name": "[variables('configurationName')]",
					"type": "compilationjobs",
					"apiVersion": "2018-01-15",
					"location": "[resourceGroup().location]",
					"tags": {},
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]",
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'), '/configurations/', variables('configurationName'))]"
					],
					"properties": {
						"configuration": {
							"name": "[variables('configurationName')]"
						}
					}
				}
			]
		},
		{
			"type": "Microsoft.OperationalInsights/workspaces",
			"name": "[variables('automationAccountName')]",
			"apiVersion": "2015-11-01-preview",
			"location": "[resourceGroup().location]",
			"properties": {
				"sku": {
					"name": "[variables('insights-sku')]"
				},
				"features": {
					"searchVersion": 1
				}
			}
		}
	],
	"outputs": {
		"automationAccountName": {
			"type": "string",
			"value": "[variables('automationAccountName')]"
		},
		"configurationName": {
			"type": "string",
			"value": "[variables('configurationName')]"
		},
		"registrationKey": {
			"type": "string",
			"value": "[listKeys(resourceId('Microsoft.Automation/automationAccounts/', variables('automationAccountName')), '2018-01-15').Keys[0].value]"
		},
		"registrationUrl": {
			"type": "string",
			"value": "[reference(concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))).registrationUrl]"
		},
		"nodeConfigurationName": {
			"type": "string",
			"value": "[variables('nodeConfigurationName')]"
		}
	}
}