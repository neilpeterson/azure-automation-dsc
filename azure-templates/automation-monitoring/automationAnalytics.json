{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location": {
			"type": "string",
			"metadata": {
			  "description": "The region of the Log Analytics workspace."
			}
		}
	},
	"variables": {
		"insights-sku": "standard",
		"configurationName": "windows-features",
		"configurationDescription": "A configuration for installing IIS.",
		"configurationURI": "https://raw.githubusercontent.com/neilpeterson/azure-automation-dsc/master/support-scripts/windows-config.ps1",
		"nodeConfigurationName": "features.localhost",
		"automationAccountName": "[uniqueString(resourceGroup().id)]",
		"name": "cpu-alert-to-teams",
		"location": "westeurope",
		"scriptURI": "https://raw.githubusercontent.com/neilpeterson/azure-automation-dsc/master/support-scripts/run-ps-script-vm.ps1"
	},
	"resources": [{
			"name": "[variables('automationAccountName')]",
			"type": "Microsoft.Automation/automationAccounts",
			"apiVersion": "2015-10-31",
			"location": "[parameters('location')]",
			"comments": "Automation account for OMS",
			"properties": {
				"sku": {
					"name": "Basic"
				}
			},
			"resources": [
				{
					"name": "[variables('configurationName')]",
					"type": "configurations",
					"apiVersion": "2015-10-31",
					"location": "[parameters('location')]",
					"tags": {},
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]"
					],
					"properties": {
						"logVerbose": true,
						"description": "[variables('configurationDescription')]",
						"state": "Published",
						"overwrite": "true",
						"source": {
							"type": "uri",
							"value": "[variables('configurationURI')]"
						}
					}
				},
				{
					"name": "[variables('configurationName')]",
					"type": "compilationjobs",
					"apiVersion": "2018-01-15",
					"location": "parameters('location')]",
					"tags": {},
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]",
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'), '/configurations/', variables('configurationName'))]"
					],
					"properties": {
						"configuration": {
							"name": "[variables('configurationName')]"
						}
					}
				},
				{
					"apiVersion": "2015-10-31",
					"type": "runbooks",
					"name": "[variables('name')]",
					"location": "[variables('location')]",
					"dependsOn": [
						"[concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))]"
					],
					"properties": {
						"runbookType": "PowerShell",
						"publishContentLink": {
							"uri": "[variables('scriptURI')]"
						}
					}
				}
			]
		},
		{
			"type": "Microsoft.OperationalInsights/workspaces",
			"name": "[variables('automationAccountName')]",
			"apiVersion": "2015-11-01-preview",
			"location": "[parameters('location')]",
			"properties": {
				"sku": {
					"name": "[variables('insights-sku')]"
				},
				"features": {
					"searchVersion": 1
				}
			}
		}
	],
	"outputs": {
		"automationAccountName":{
			"type": "string",
			"value": "[variables('automationAccountName')]"
		},
		"configurationName":{
			"type": "string",
			"value": "[variables('configurationName')]"
		},
		"registrationKey":{
			"type": "string",
			"value": "[listKeys(resourceId('Microsoft.Automation/automationAccounts/', variables('automationAccountName')), '2018-01-15').Keys[0].value]"
		},
		"registrationUrl":{
			"type": "string",
			"value": "[reference(concat('Microsoft.Automation/automationAccounts/', variables('automationAccountName'))).registrationUrl]"
		},
		"nodeConfigurationName":{
			"type": "string",
			"value": "[variables('nodeConfigurationName')]"
		}
	}
}